// Generated by CoffeeScript 1.6.3
(function() {
  var $, getcookie, updater;

  $ = jQuery;

  updater = {
    socket: null,
    start: function() {
      var url;
      url = 'ws://' + location.host + '/message';
      updater.socket = new WebSocket(url);
      return updater.socket.onmessage = function(e) {
        console.log(e);
        return updater.showMessage(JSON.parse(e.data));
      };
    },
    showMessage: function(msg) {
      var _from, _h;
      console.log(msg);
      if (msg.type === 1) {
        console.log('1');
        return $(".online-num").text(parseInt($(".online-num").text()) + msg.addNum);
      } else if (msg.type === 2) {
        console.log('2');
        return $(".sysinfo").text(msg.msg);
      } else if (msg.type === 3) {
        console.log('3');
        _from = msg.from === $(".username").text() ? 'me' : msg.from;
        _h = "<div class='alert-box info'>" + msg.content + "-->" + _from + "</div>";
        return $(".msghub").prepend(_h);
      }
    }
  };

  getcookie = function(name) {
    var r;
    r = document.cookie.match("\\b" + name + "=([^;]*)\\b");
    if (r) {
      return r[1];
    } else {
      return null;
    }
  };

  $(function() {
    console.log('message in...');
    $("#send").click(function(e) {
      return updater.socket.send(JSON.stringify({
        type: 1
      }));
    });
    updater.start();
    $(".close").click(function(e) {
      e.preventDefault();
      return $(this).parent("div").hide("slow");
    });
    $(".tozoom").click(function(e) {
      var _t;
      console.log('send');
      _t = $(".cc").val();
      if (!_t) {
        alert('send error');
        $(".cc").value("");
        return;
      }
      return updater.socket.send(JSON.stringify({
        content: _t,
        'userid': $.cookie("userid")
      }));
    });
    return $(".msg-send-btn").click(function(e) {
      var args, _content, _flag, _from, _to;
      console.log('msg-send-btn');
      _flag = $(".msg-send-content");
      _content = _flag.val();
      _from = $('#chat').text();
      _to = $("#chat-with").text();
      args = {
        '_xsrf': getcookie('_xsrf'),
        'from': _from,
        'to': _to,
        'content': _content
      };
      console.log(args);
      return $.post('/chat/c', args, function(data, textStatus, xhr) {
        var _data, _ihtml;
        console.log(data, textStatus);
        _data = $.parseJSON(data);
        if (!_data['result']) {
          return;
        }
        _ihtml = $("<li>" + _content + "</li>");
        return $(".msg-content-ul").append(_ihtml);
      });
    });
  });

}).call(this);
