# -*- coding:utf-8 -*-
from django.http import HttpResponse
from official import WxRequest, WxTextResponse
import hashlib
from bae.api import logging
from datetime import datetime
from django.views.decorators.csrf import csrf_exempt 
from utils import Weather, BaiduBus

@csrf_exempt
def index(request): 
    signature = request.GET.get("signature", None)  
    timestamp = request.GET.get("timestamp", None)  
    nonce = request.GET.get("nonce", None)  
    echoStr = request.GET.get("echostr",None) 
    token = "dianyiwx"
    if request.method == 'GET':  
        tmpList = [token,timestamp,nonce]  
        tmpList.sort()
        tmpstr = "%s%s%s" % tuple(tmpList) 
        tmpstr = hashlib.sha1(tmpstr).hexdigest()  
        if tmpstr == signature:  
            return HttpResponse(echoStr)
    req = WxRequest(request.body)
    logging.info(req)
    if req.MsgType == 'text':
        # return HttpResponse(WxTextResponse(req.Content, req).as_xml())
        return parseText(req.Content, req)
    elif req.MsgType == 'event' and req.Event == 'subscribe':
        return HttpResponse(WxTextResponse(u'欢迎来到小刀的世界，因为我你不再寂寞。。。请按提示操作：0.帮助文档 1.冷笑话',
                                           req).as_xml())
    else:
        return HttpResponse(WxTextResponse('嘿，小心使用！',
                                           req).as_xml())
    return HttpResponse("error")

def parseText(text, req):
    if '1' == text:
        '''冷笑话'''
        content = u"芝忠说：好巧哦，在广州遇见你。小毛说：是是是，心灵手巧而已 —— ——！！！"
    elif '0' == text:
        '''帮助文档'''
        content = u"0.帮助文档 1.冷笑话'"
    elif '2' == text:
        weather = Weather()
        req_text = "%s|%s|%s|%s" % (weather.temp, weather.weather, weather.wind, weather.index)
        return HttpResponse(WxTextResponse(req_text, req).as_xml())
    else:
        content = u"别整那些没用的！！！"
    return HttpResponse(WxTextResponse(content, req).as_xml())
